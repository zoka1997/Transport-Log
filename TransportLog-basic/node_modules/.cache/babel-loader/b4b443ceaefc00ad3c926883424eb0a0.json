{"ast":null,"code":"/**\r\n * DevExtreme (esm/ui/grid_core/ui.grid.core.virtual_data_loader.js)\r\n * Version: 22.1.6\r\n * Build date: Tue Oct 18 2022\r\n *\r\n * Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport { Deferred, when } from \"../../core/utils/deferred\";\nimport { isObject, isString } from \"../../core/utils/type\";\nvar LEGACY_SCROLLING_MODE = \"scrolling.legacyMode\";\n\nvar needTwoPagesLoading = that => that.option(\"scrolling.loadTwoPagesOnStart\") || that._controller.isVirtual() || that._controller.getViewportItemIndex() > 0;\n\nvar getBeginPageIndex = that => that._cache.length ? that._cache[0].pageIndex : -1;\n\nvar getEndPageIndex = that => that._cache.length ? that._cache[that._cache.length - 1].pageIndex : -1;\n\nvar fireChanged = (that, changed, args) => {\n  that._isChangedFiring = true;\n  changed(args);\n  that._isChangedFiring = false;\n};\n\nvar processDelayChanged = (that, changed, args) => {\n  if (that._isDelayChanged) {\n    that._isDelayChanged = false;\n    fireChanged(that, changed, args);\n    return true;\n  }\n};\n\nvar getViewportPageCount = that => {\n  var pageSize = that._dataOptions.pageSize();\n\n  var preventPreload = that.option(\"scrolling.preventPreload\");\n\n  if (preventPreload) {\n    return 0;\n  }\n\n  var realViewportSize = that._controller.viewportSize();\n\n  if (that._controller.isVirtualMode() && that.option(\"scrolling.removeInvisiblePages\")) {\n    realViewportSize = 0;\n\n    var viewportSize = that._controller.viewportSize() * that._controller.viewportItemSize();\n\n    var offset = that._controller.getContentOffset();\n\n    var position = that._controller.getViewportPosition();\n\n    var virtualItemsCount = that._controller.virtualItemsCount();\n\n    var totalItemsCount = that._dataOptions.totalItemsCount();\n\n    for (var itemIndex = virtualItemsCount.begin; itemIndex < totalItemsCount; itemIndex++) {\n      if (offset >= position + viewportSize) {\n        break;\n      }\n\n      var itemSize = that._controller.getItemSizes()[itemIndex] || that._controller.viewportItemSize();\n\n      offset += itemSize;\n\n      if (offset >= position) {\n        realViewportSize++;\n      }\n    }\n  }\n\n  return pageSize && realViewportSize > 0 ? Math.ceil(realViewportSize / pageSize) : 1;\n};\n\nvar getPreloadPageCount = (that, previous) => {\n  var preloadEnabled = that.option(\"scrolling.preloadEnabled\");\n  var pageCount = getViewportPageCount(that);\n\n  var isAppendMode = that._controller.isAppendMode();\n\n  if (pageCount) {\n    if (previous) {\n      pageCount = preloadEnabled ? 1 : 0;\n    } else {\n      if (preloadEnabled) {\n        pageCount++;\n      }\n\n      if (isAppendMode || !needTwoPagesLoading(that)) {\n        pageCount--;\n      }\n    }\n  }\n\n  return pageCount;\n};\n\nvar getPageIndexForLoad = that => {\n  var result = -1;\n  var beginPageIndex = getBeginPageIndex(that);\n  var dataOptions = that._dataOptions;\n\n  if (beginPageIndex < 0) {\n    result = that._pageIndex;\n  } else if (!that._cache[that._pageIndex - beginPageIndex]) {\n    result = that._pageIndex;\n  } else if (beginPageIndex >= 0 && that._controller.viewportSize() >= 0) {\n    if (beginPageIndex > 0) {\n      var needToLoadPageBeforeLast = getEndPageIndex(that) + 1 === dataOptions.pageCount() && that._cache.length < getPreloadPageCount(that) + 1;\n      var needToLoadPrevPage = needToLoadPageBeforeLast || that._pageIndex === beginPageIndex && getPreloadPageCount(that, true);\n\n      if (needToLoadPrevPage) {\n        result = beginPageIndex - 1;\n      }\n    }\n\n    if (result < 0) {\n      var needToLoadNextPage = beginPageIndex + that._cache.length <= that._pageIndex + getPreloadPageCount(that);\n\n      if (needToLoadNextPage) {\n        result = beginPageIndex + that._cache.length;\n      }\n    }\n  }\n\n  if (that._loadingPageIndexes[result]) {\n    result = -1;\n  }\n\n  return result;\n};\n\nvar loadCore = (that, pageIndex) => {\n  var dataOptions = that._dataOptions;\n\n  if (pageIndex === that.pageIndex() || !dataOptions.isLoading() && pageIndex < dataOptions.pageCount() || !dataOptions.hasKnownLastPage() && pageIndex === dataOptions.pageCount()) {\n    dataOptions.pageIndex(pageIndex);\n    that._loadingPageIndexes[pageIndex] = true;\n    return when(dataOptions.load()).always(() => {\n      that._loadingPageIndexes[pageIndex] = false;\n    });\n  }\n};\n\nvar processChanged = (that, changed, changeType, isDelayChanged, removeCacheItem) => {\n  var dataOptions = that._dataOptions;\n  var items = dataOptions.items().slice();\n  var change = isObject(changeType) ? changeType : void 0;\n  var isPrepend = \"prepend\" === changeType;\n  var viewportItems = dataOptions.viewportItems();\n\n  if (changeType && isString(changeType) && !that._isDelayChanged) {\n    change = {\n      changeType: changeType,\n      items: items\n    };\n\n    if (removeCacheItem) {\n      change.removeCount = removeCacheItem.itemsCount;\n\n      if (change.removeCount && dataOptions.correctCount) {\n        change.removeCount = dataOptions.correctCount(viewportItems, change.removeCount, isPrepend);\n      }\n    }\n  }\n\n  var removeItemCount = removeCacheItem ? removeCacheItem.itemsLength : 0;\n\n  if (removeItemCount && dataOptions.correctCount) {\n    removeItemCount = dataOptions.correctCount(viewportItems, removeItemCount, isPrepend);\n  }\n\n  if (\"append\" === changeType) {\n    viewportItems.push.apply(viewportItems, items);\n\n    if (removeCacheItem) {\n      viewportItems.splice(0, removeItemCount);\n    }\n  } else if (isPrepend) {\n    viewportItems.unshift.apply(viewportItems, items);\n\n    if (removeCacheItem) {\n      viewportItems.splice(-removeItemCount);\n    }\n  } else {\n    that._dataOptions.viewportItems(items);\n  }\n\n  dataOptions.updateLoading();\n  that._lastPageIndex = that.pageIndex();\n  that._isDelayChanged = isDelayChanged;\n\n  if (!isDelayChanged) {\n    fireChanged(that, changed, change);\n  }\n};\n\nexport class VirtualDataLoader {\n  constructor(controller, dataOptions) {\n    this._controller = controller;\n    this._dataOptions = dataOptions;\n    this._pageIndex = this._lastPageIndex = dataOptions.pageIndex();\n    this._cache = [];\n    this._loadingPageIndexes = {};\n  }\n\n  option() {\n    return this._controller.option.apply(this._controller, arguments);\n  }\n\n  viewportItemIndexChanged(itemIndex) {\n    var pageSize = this._dataOptions.pageSize();\n\n    var pageCount = this._dataOptions.pageCount();\n\n    var virtualMode = this._controller.isVirtualMode();\n\n    var appendMode = this._controller.isAppendMode();\n\n    var totalItemsCount = this._dataOptions.totalItemsCount();\n\n    var newPageIndex;\n\n    if (pageSize && (virtualMode || appendMode) && totalItemsCount >= 0) {\n      var viewportSize = this._controller.viewportSize();\n\n      if (viewportSize && itemIndex + viewportSize >= totalItemsCount && !this._controller.isVirtual()) {\n        if (this._dataOptions.hasKnownLastPage()) {\n          newPageIndex = pageCount - 1;\n          var lastPageSize = totalItemsCount % pageSize;\n\n          if (newPageIndex > 0 && lastPageSize > 0 && lastPageSize < viewportSize) {\n            newPageIndex--;\n          }\n        } else {\n          newPageIndex = pageCount;\n        }\n      } else {\n        newPageIndex = Math.floor(itemIndex / pageSize);\n        var maxPageIndex = pageCount - 1;\n        newPageIndex = Math.max(newPageIndex, 0);\n        newPageIndex = Math.min(newPageIndex, maxPageIndex);\n      }\n\n      this.pageIndex(newPageIndex);\n      return this.load();\n    }\n  }\n\n  pageIndex(pageIndex) {\n    var isVirtualMode = this._controller.isVirtualMode();\n\n    var isAppendMode = this._controller.isAppendMode();\n\n    if (false !== this.option(LEGACY_SCROLLING_MODE) && (isVirtualMode || isAppendMode)) {\n      if (void 0 !== pageIndex) {\n        this._pageIndex = pageIndex;\n      }\n\n      return this._pageIndex;\n    } else {\n      return this._dataOptions.pageIndex(pageIndex);\n    }\n  }\n\n  beginPageIndex(defaultPageIndex) {\n    var beginPageIndex = getBeginPageIndex(this);\n\n    if (beginPageIndex < 0) {\n      beginPageIndex = void 0 !== defaultPageIndex ? defaultPageIndex : this.pageIndex();\n    }\n\n    return beginPageIndex;\n  }\n\n  endPageIndex() {\n    var endPageIndex = getEndPageIndex(this);\n    return endPageIndex > 0 ? endPageIndex : this._lastPageIndex;\n  }\n\n  pageSize() {\n    return this._dataOptions.pageSize();\n  }\n\n  load() {\n    var dataOptions = this._dataOptions;\n    var result;\n\n    var isVirtualMode = this._controller.isVirtualMode();\n\n    var isAppendMode = this._controller.isAppendMode();\n\n    if (false !== this.option(LEGACY_SCROLLING_MODE) && (isVirtualMode || isAppendMode)) {\n      var pageIndexForLoad = getPageIndexForLoad(this);\n\n      if (pageIndexForLoad >= 0) {\n        var loadResult = loadCore(this, pageIndexForLoad);\n\n        if (loadResult) {\n          result = new Deferred();\n          loadResult.done(() => {\n            var delayDeferred = this._delayDeferred;\n\n            if (delayDeferred) {\n              delayDeferred.done(result.resolve).fail(result.reject);\n            } else {\n              result.resolve();\n            }\n          }).fail(result.reject);\n          dataOptions.updateLoading();\n        }\n      }\n    } else {\n      result = dataOptions.load();\n    }\n\n    if (!result && this._lastPageIndex !== this.pageIndex()) {\n      this._dataOptions.onChanged({\n        changeType: \"pageIndex\"\n      });\n    }\n\n    return result || new Deferred().resolve();\n  }\n\n  loadIfNeed() {\n    var isVirtualMode = this._controller.isVirtualMode();\n\n    var isAppendMode = this._controller.isAppendMode();\n\n    if ((isVirtualMode || isAppendMode) && !this._dataOptions.isLoading() && (!this._isChangedFiring || this._controller.isVirtual())) {\n      var position = this._controller.getViewportPosition();\n\n      if (position > 0) {\n        this._controller._setViewportPositionCore(position);\n      } else {\n        this.load();\n      }\n    }\n  }\n\n  handleDataChanged(callBase, e) {\n    var dataOptions = this._dataOptions;\n    var lastCacheLength = this._cache.length;\n    var changeType;\n    var removeInvisiblePages;\n\n    var isVirtualMode = this._controller.isVirtualMode();\n\n    var isAppendMode = this._controller.isAppendMode();\n\n    if (e && e.changes) {\n      fireChanged(this, callBase, e);\n    } else if (false !== this.option(LEGACY_SCROLLING_MODE) && (isVirtualMode || isAppendMode)) {\n      var beginPageIndex = getBeginPageIndex(this);\n\n      if (beginPageIndex >= 0) {\n        if (isVirtualMode && beginPageIndex + this._cache.length !== dataOptions.pageIndex() && beginPageIndex - 1 !== dataOptions.pageIndex()) {\n          lastCacheLength = 0;\n          this._cache = [];\n        }\n\n        if (isAppendMode) {\n          if (0 === dataOptions.pageIndex()) {\n            this._cache = [];\n          } else if (dataOptions.pageIndex() < getEndPageIndex(this)) {\n            fireChanged(this, callBase, {\n              changeType: \"append\",\n              items: []\n            });\n            return;\n          }\n        }\n      }\n\n      var cacheItem = {\n        pageIndex: dataOptions.pageIndex(),\n        itemsLength: dataOptions.items(true).length,\n        itemsCount: this.itemsCount(true)\n      };\n\n      if (this.option(\"scrolling.removeInvisiblePages\") && isVirtualMode) {\n        removeInvisiblePages = this._cache.length > Math.max(getPreloadPageCount(this) + (this.option(\"scrolling.preloadEnabled\") ? 1 : 0), 2);\n      } else {\n        processDelayChanged(this, callBase, {\n          isDelayed: true\n        });\n      }\n\n      var removeCacheItem;\n\n      if (beginPageIndex === dataOptions.pageIndex() + 1) {\n        if (removeInvisiblePages) {\n          removeCacheItem = this._cache.pop();\n        }\n\n        changeType = \"prepend\";\n\n        this._cache.unshift(cacheItem);\n      } else {\n        if (removeInvisiblePages) {\n          removeCacheItem = this._cache.shift();\n        }\n\n        changeType = \"append\";\n\n        this._cache.push(cacheItem);\n      }\n\n      var isDelayChanged = isVirtualMode && 0 === lastCacheLength && needTwoPagesLoading(this);\n      processChanged(this, callBase, this._cache.length > 1 ? changeType : void 0, isDelayChanged, removeCacheItem);\n      this._delayDeferred = this.load().done(() => {\n        if (processDelayChanged(this, callBase)) {\n          this.load();\n        }\n      });\n    } else {\n      processChanged(this, callBase, e);\n    }\n  }\n\n  getDelayDeferred() {\n    return this._delayDeferred;\n  }\n\n  itemsCount(isBase) {\n    var itemsCount = 0;\n\n    var isVirtualMode = this._controller.isVirtualMode();\n\n    if (!isBase && isVirtualMode) {\n      this._cache.forEach(cacheItem => {\n        itemsCount += cacheItem.itemsCount;\n      });\n    } else {\n      itemsCount = this._dataOptions.itemsCount();\n    }\n\n    return itemsCount;\n  }\n\n  virtualItemsCount() {\n    var pageIndex = getBeginPageIndex(this);\n\n    if (pageIndex < 0) {\n      pageIndex = this._dataOptions.pageIndex();\n    }\n\n    var beginItemsCount = pageIndex * this._dataOptions.pageSize();\n\n    var itemsCount = this._cache.length * this._dataOptions.pageSize();\n\n    var endItemsCount = Math.max(0, this._dataOptions.totalItemsCount() - itemsCount - beginItemsCount);\n    return {\n      begin: beginItemsCount,\n      end: endItemsCount\n    };\n  }\n\n  reset() {\n    this._loadingPageIndexes = {};\n    this._cache = [];\n  }\n\n}","map":{"version":3,"sources":["C:/Users/Zoran/source/repos/TransportApp/TransportLog-basic/node_modules/devextreme/esm/ui/grid_core/ui.grid.core.virtual_data_loader.js"],"names":["Deferred","when","isObject","isString","LEGACY_SCROLLING_MODE","needTwoPagesLoading","that","option","_controller","isVirtual","getViewportItemIndex","getBeginPageIndex","_cache","length","pageIndex","getEndPageIndex","fireChanged","changed","args","_isChangedFiring","processDelayChanged","_isDelayChanged","getViewportPageCount","pageSize","_dataOptions","preventPreload","realViewportSize","viewportSize","isVirtualMode","viewportItemSize","offset","getContentOffset","position","getViewportPosition","virtualItemsCount","totalItemsCount","itemIndex","begin","itemSize","getItemSizes","Math","ceil","getPreloadPageCount","previous","preloadEnabled","pageCount","isAppendMode","getPageIndexForLoad","result","beginPageIndex","dataOptions","_pageIndex","needToLoadPageBeforeLast","needToLoadPrevPage","needToLoadNextPage","_loadingPageIndexes","loadCore","isLoading","hasKnownLastPage","load","always","processChanged","changeType","isDelayChanged","removeCacheItem","items","slice","change","isPrepend","viewportItems","removeCount","itemsCount","correctCount","removeItemCount","itemsLength","push","apply","splice","unshift","updateLoading","_lastPageIndex","VirtualDataLoader","constructor","controller","arguments","viewportItemIndexChanged","virtualMode","appendMode","newPageIndex","lastPageSize","floor","maxPageIndex","max","min","defaultPageIndex","endPageIndex","pageIndexForLoad","loadResult","done","delayDeferred","_delayDeferred","resolve","fail","reject","onChanged","loadIfNeed","_setViewportPositionCore","handleDataChanged","callBase","e","lastCacheLength","removeInvisiblePages","changes","cacheItem","isDelayed","pop","shift","getDelayDeferred","isBase","forEach","beginItemsCount","endItemsCount","end","reset"],"mappings":"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","sourcesContent":["/**\r\n * DevExtreme (esm/ui/grid_core/ui.grid.core.virtual_data_loader.js)\r\n * Version: 22.1.6\r\n * Build date: Tue Oct 18 2022\r\n *\r\n * Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\r\nimport {\r\n    Deferred,\r\n    when\r\n} from \"../../core/utils/deferred\";\r\nimport {\r\n    isObject,\r\n    isString\r\n} from \"../../core/utils/type\";\r\nvar LEGACY_SCROLLING_MODE = \"scrolling.legacyMode\";\r\nvar needTwoPagesLoading = that => that.option(\"scrolling.loadTwoPagesOnStart\") || that._controller.isVirtual() || that._controller.getViewportItemIndex() > 0;\r\nvar getBeginPageIndex = that => that._cache.length ? that._cache[0].pageIndex : -1;\r\nvar getEndPageIndex = that => that._cache.length ? that._cache[that._cache.length - 1].pageIndex : -1;\r\nvar fireChanged = (that, changed, args) => {\r\n    that._isChangedFiring = true;\r\n    changed(args);\r\n    that._isChangedFiring = false\r\n};\r\nvar processDelayChanged = (that, changed, args) => {\r\n    if (that._isDelayChanged) {\r\n        that._isDelayChanged = false;\r\n        fireChanged(that, changed, args);\r\n        return true\r\n    }\r\n};\r\nvar getViewportPageCount = that => {\r\n    var pageSize = that._dataOptions.pageSize();\r\n    var preventPreload = that.option(\"scrolling.preventPreload\");\r\n    if (preventPreload) {\r\n        return 0\r\n    }\r\n    var realViewportSize = that._controller.viewportSize();\r\n    if (that._controller.isVirtualMode() && that.option(\"scrolling.removeInvisiblePages\")) {\r\n        realViewportSize = 0;\r\n        var viewportSize = that._controller.viewportSize() * that._controller.viewportItemSize();\r\n        var offset = that._controller.getContentOffset();\r\n        var position = that._controller.getViewportPosition();\r\n        var virtualItemsCount = that._controller.virtualItemsCount();\r\n        var totalItemsCount = that._dataOptions.totalItemsCount();\r\n        for (var itemIndex = virtualItemsCount.begin; itemIndex < totalItemsCount; itemIndex++) {\r\n            if (offset >= position + viewportSize) {\r\n                break\r\n            }\r\n            var itemSize = that._controller.getItemSizes()[itemIndex] || that._controller.viewportItemSize();\r\n            offset += itemSize;\r\n            if (offset >= position) {\r\n                realViewportSize++\r\n            }\r\n        }\r\n    }\r\n    return pageSize && realViewportSize > 0 ? Math.ceil(realViewportSize / pageSize) : 1\r\n};\r\nvar getPreloadPageCount = (that, previous) => {\r\n    var preloadEnabled = that.option(\"scrolling.preloadEnabled\");\r\n    var pageCount = getViewportPageCount(that);\r\n    var isAppendMode = that._controller.isAppendMode();\r\n    if (pageCount) {\r\n        if (previous) {\r\n            pageCount = preloadEnabled ? 1 : 0\r\n        } else {\r\n            if (preloadEnabled) {\r\n                pageCount++\r\n            }\r\n            if (isAppendMode || !needTwoPagesLoading(that)) {\r\n                pageCount--\r\n            }\r\n        }\r\n    }\r\n    return pageCount\r\n};\r\nvar getPageIndexForLoad = that => {\r\n    var result = -1;\r\n    var beginPageIndex = getBeginPageIndex(that);\r\n    var dataOptions = that._dataOptions;\r\n    if (beginPageIndex < 0) {\r\n        result = that._pageIndex\r\n    } else if (!that._cache[that._pageIndex - beginPageIndex]) {\r\n        result = that._pageIndex\r\n    } else if (beginPageIndex >= 0 && that._controller.viewportSize() >= 0) {\r\n        if (beginPageIndex > 0) {\r\n            var needToLoadPageBeforeLast = getEndPageIndex(that) + 1 === dataOptions.pageCount() && that._cache.length < getPreloadPageCount(that) + 1;\r\n            var needToLoadPrevPage = needToLoadPageBeforeLast || that._pageIndex === beginPageIndex && getPreloadPageCount(that, true);\r\n            if (needToLoadPrevPage) {\r\n                result = beginPageIndex - 1\r\n            }\r\n        }\r\n        if (result < 0) {\r\n            var needToLoadNextPage = beginPageIndex + that._cache.length <= that._pageIndex + getPreloadPageCount(that);\r\n            if (needToLoadNextPage) {\r\n                result = beginPageIndex + that._cache.length\r\n            }\r\n        }\r\n    }\r\n    if (that._loadingPageIndexes[result]) {\r\n        result = -1\r\n    }\r\n    return result\r\n};\r\nvar loadCore = (that, pageIndex) => {\r\n    var dataOptions = that._dataOptions;\r\n    if (pageIndex === that.pageIndex() || !dataOptions.isLoading() && pageIndex < dataOptions.pageCount() || !dataOptions.hasKnownLastPage() && pageIndex === dataOptions.pageCount()) {\r\n        dataOptions.pageIndex(pageIndex);\r\n        that._loadingPageIndexes[pageIndex] = true;\r\n        return when(dataOptions.load()).always(() => {\r\n            that._loadingPageIndexes[pageIndex] = false\r\n        })\r\n    }\r\n};\r\nvar processChanged = (that, changed, changeType, isDelayChanged, removeCacheItem) => {\r\n    var dataOptions = that._dataOptions;\r\n    var items = dataOptions.items().slice();\r\n    var change = isObject(changeType) ? changeType : void 0;\r\n    var isPrepend = \"prepend\" === changeType;\r\n    var viewportItems = dataOptions.viewportItems();\r\n    if (changeType && isString(changeType) && !that._isDelayChanged) {\r\n        change = {\r\n            changeType: changeType,\r\n            items: items\r\n        };\r\n        if (removeCacheItem) {\r\n            change.removeCount = removeCacheItem.itemsCount;\r\n            if (change.removeCount && dataOptions.correctCount) {\r\n                change.removeCount = dataOptions.correctCount(viewportItems, change.removeCount, isPrepend)\r\n            }\r\n        }\r\n    }\r\n    var removeItemCount = removeCacheItem ? removeCacheItem.itemsLength : 0;\r\n    if (removeItemCount && dataOptions.correctCount) {\r\n        removeItemCount = dataOptions.correctCount(viewportItems, removeItemCount, isPrepend)\r\n    }\r\n    if (\"append\" === changeType) {\r\n        viewportItems.push.apply(viewportItems, items);\r\n        if (removeCacheItem) {\r\n            viewportItems.splice(0, removeItemCount)\r\n        }\r\n    } else if (isPrepend) {\r\n        viewportItems.unshift.apply(viewportItems, items);\r\n        if (removeCacheItem) {\r\n            viewportItems.splice(-removeItemCount)\r\n        }\r\n    } else {\r\n        that._dataOptions.viewportItems(items)\r\n    }\r\n    dataOptions.updateLoading();\r\n    that._lastPageIndex = that.pageIndex();\r\n    that._isDelayChanged = isDelayChanged;\r\n    if (!isDelayChanged) {\r\n        fireChanged(that, changed, change)\r\n    }\r\n};\r\nexport class VirtualDataLoader {\r\n    constructor(controller, dataOptions) {\r\n        this._controller = controller;\r\n        this._dataOptions = dataOptions;\r\n        this._pageIndex = this._lastPageIndex = dataOptions.pageIndex();\r\n        this._cache = [];\r\n        this._loadingPageIndexes = {}\r\n    }\r\n    option() {\r\n        return this._controller.option.apply(this._controller, arguments)\r\n    }\r\n    viewportItemIndexChanged(itemIndex) {\r\n        var pageSize = this._dataOptions.pageSize();\r\n        var pageCount = this._dataOptions.pageCount();\r\n        var virtualMode = this._controller.isVirtualMode();\r\n        var appendMode = this._controller.isAppendMode();\r\n        var totalItemsCount = this._dataOptions.totalItemsCount();\r\n        var newPageIndex;\r\n        if (pageSize && (virtualMode || appendMode) && totalItemsCount >= 0) {\r\n            var viewportSize = this._controller.viewportSize();\r\n            if (viewportSize && itemIndex + viewportSize >= totalItemsCount && !this._controller.isVirtual()) {\r\n                if (this._dataOptions.hasKnownLastPage()) {\r\n                    newPageIndex = pageCount - 1;\r\n                    var lastPageSize = totalItemsCount % pageSize;\r\n                    if (newPageIndex > 0 && lastPageSize > 0 && lastPageSize < viewportSize) {\r\n                        newPageIndex--\r\n                    }\r\n                } else {\r\n                    newPageIndex = pageCount\r\n                }\r\n            } else {\r\n                newPageIndex = Math.floor(itemIndex / pageSize);\r\n                var maxPageIndex = pageCount - 1;\r\n                newPageIndex = Math.max(newPageIndex, 0);\r\n                newPageIndex = Math.min(newPageIndex, maxPageIndex)\r\n            }\r\n            this.pageIndex(newPageIndex);\r\n            return this.load()\r\n        }\r\n    }\r\n    pageIndex(pageIndex) {\r\n        var isVirtualMode = this._controller.isVirtualMode();\r\n        var isAppendMode = this._controller.isAppendMode();\r\n        if (false !== this.option(LEGACY_SCROLLING_MODE) && (isVirtualMode || isAppendMode)) {\r\n            if (void 0 !== pageIndex) {\r\n                this._pageIndex = pageIndex\r\n            }\r\n            return this._pageIndex\r\n        } else {\r\n            return this._dataOptions.pageIndex(pageIndex)\r\n        }\r\n    }\r\n    beginPageIndex(defaultPageIndex) {\r\n        var beginPageIndex = getBeginPageIndex(this);\r\n        if (beginPageIndex < 0) {\r\n            beginPageIndex = void 0 !== defaultPageIndex ? defaultPageIndex : this.pageIndex()\r\n        }\r\n        return beginPageIndex\r\n    }\r\n    endPageIndex() {\r\n        var endPageIndex = getEndPageIndex(this);\r\n        return endPageIndex > 0 ? endPageIndex : this._lastPageIndex\r\n    }\r\n    pageSize() {\r\n        return this._dataOptions.pageSize()\r\n    }\r\n    load() {\r\n        var dataOptions = this._dataOptions;\r\n        var result;\r\n        var isVirtualMode = this._controller.isVirtualMode();\r\n        var isAppendMode = this._controller.isAppendMode();\r\n        if (false !== this.option(LEGACY_SCROLLING_MODE) && (isVirtualMode || isAppendMode)) {\r\n            var pageIndexForLoad = getPageIndexForLoad(this);\r\n            if (pageIndexForLoad >= 0) {\r\n                var loadResult = loadCore(this, pageIndexForLoad);\r\n                if (loadResult) {\r\n                    result = new Deferred;\r\n                    loadResult.done(() => {\r\n                        var delayDeferred = this._delayDeferred;\r\n                        if (delayDeferred) {\r\n                            delayDeferred.done(result.resolve).fail(result.reject)\r\n                        } else {\r\n                            result.resolve()\r\n                        }\r\n                    }).fail(result.reject);\r\n                    dataOptions.updateLoading()\r\n                }\r\n            }\r\n        } else {\r\n            result = dataOptions.load()\r\n        }\r\n        if (!result && this._lastPageIndex !== this.pageIndex()) {\r\n            this._dataOptions.onChanged({\r\n                changeType: \"pageIndex\"\r\n            })\r\n        }\r\n        return result || (new Deferred).resolve()\r\n    }\r\n    loadIfNeed() {\r\n        var isVirtualMode = this._controller.isVirtualMode();\r\n        var isAppendMode = this._controller.isAppendMode();\r\n        if ((isVirtualMode || isAppendMode) && !this._dataOptions.isLoading() && (!this._isChangedFiring || this._controller.isVirtual())) {\r\n            var position = this._controller.getViewportPosition();\r\n            if (position > 0) {\r\n                this._controller._setViewportPositionCore(position)\r\n            } else {\r\n                this.load()\r\n            }\r\n        }\r\n    }\r\n    handleDataChanged(callBase, e) {\r\n        var dataOptions = this._dataOptions;\r\n        var lastCacheLength = this._cache.length;\r\n        var changeType;\r\n        var removeInvisiblePages;\r\n        var isVirtualMode = this._controller.isVirtualMode();\r\n        var isAppendMode = this._controller.isAppendMode();\r\n        if (e && e.changes) {\r\n            fireChanged(this, callBase, e)\r\n        } else if (false !== this.option(LEGACY_SCROLLING_MODE) && (isVirtualMode || isAppendMode)) {\r\n            var beginPageIndex = getBeginPageIndex(this);\r\n            if (beginPageIndex >= 0) {\r\n                if (isVirtualMode && beginPageIndex + this._cache.length !== dataOptions.pageIndex() && beginPageIndex - 1 !== dataOptions.pageIndex()) {\r\n                    lastCacheLength = 0;\r\n                    this._cache = []\r\n                }\r\n                if (isAppendMode) {\r\n                    if (0 === dataOptions.pageIndex()) {\r\n                        this._cache = []\r\n                    } else if (dataOptions.pageIndex() < getEndPageIndex(this)) {\r\n                        fireChanged(this, callBase, {\r\n                            changeType: \"append\",\r\n                            items: []\r\n                        });\r\n                        return\r\n                    }\r\n                }\r\n            }\r\n            var cacheItem = {\r\n                pageIndex: dataOptions.pageIndex(),\r\n                itemsLength: dataOptions.items(true).length,\r\n                itemsCount: this.itemsCount(true)\r\n            };\r\n            if (this.option(\"scrolling.removeInvisiblePages\") && isVirtualMode) {\r\n                removeInvisiblePages = this._cache.length > Math.max(getPreloadPageCount(this) + (this.option(\"scrolling.preloadEnabled\") ? 1 : 0), 2)\r\n            } else {\r\n                processDelayChanged(this, callBase, {\r\n                    isDelayed: true\r\n                })\r\n            }\r\n            var removeCacheItem;\r\n            if (beginPageIndex === dataOptions.pageIndex() + 1) {\r\n                if (removeInvisiblePages) {\r\n                    removeCacheItem = this._cache.pop()\r\n                }\r\n                changeType = \"prepend\";\r\n                this._cache.unshift(cacheItem)\r\n            } else {\r\n                if (removeInvisiblePages) {\r\n                    removeCacheItem = this._cache.shift()\r\n                }\r\n                changeType = \"append\";\r\n                this._cache.push(cacheItem)\r\n            }\r\n            var isDelayChanged = isVirtualMode && 0 === lastCacheLength && needTwoPagesLoading(this);\r\n            processChanged(this, callBase, this._cache.length > 1 ? changeType : void 0, isDelayChanged, removeCacheItem);\r\n            this._delayDeferred = this.load().done(() => {\r\n                if (processDelayChanged(this, callBase)) {\r\n                    this.load()\r\n                }\r\n            })\r\n        } else {\r\n            processChanged(this, callBase, e)\r\n        }\r\n    }\r\n    getDelayDeferred() {\r\n        return this._delayDeferred\r\n    }\r\n    itemsCount(isBase) {\r\n        var itemsCount = 0;\r\n        var isVirtualMode = this._controller.isVirtualMode();\r\n        if (!isBase && isVirtualMode) {\r\n            this._cache.forEach(cacheItem => {\r\n                itemsCount += cacheItem.itemsCount\r\n            })\r\n        } else {\r\n            itemsCount = this._dataOptions.itemsCount()\r\n        }\r\n        return itemsCount\r\n    }\r\n    virtualItemsCount() {\r\n        var pageIndex = getBeginPageIndex(this);\r\n        if (pageIndex < 0) {\r\n            pageIndex = this._dataOptions.pageIndex()\r\n        }\r\n        var beginItemsCount = pageIndex * this._dataOptions.pageSize();\r\n        var itemsCount = this._cache.length * this._dataOptions.pageSize();\r\n        var endItemsCount = Math.max(0, this._dataOptions.totalItemsCount() - itemsCount - beginItemsCount);\r\n        return {\r\n            begin: beginItemsCount,\r\n            end: endItemsCount\r\n        }\r\n    }\r\n    reset() {\r\n        this._loadingPageIndexes = {};\r\n        this._cache = []\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}